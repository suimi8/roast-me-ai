@echo off
chcp 65001 >nul
title ğŸ“¦ roast-me-ai æ‰“åŒ… + å‘å¸ƒå·¥å…·

:: ============================================================
::  roast-me-ai ä¸€é”®æ‰“åŒ… + è‡ªåŠ¨å‘å¸ƒ GitHub Release è„šæœ¬
::  æµç¨‹ï¼š
::    1. æ£€æŸ¥ç¯å¢ƒ (Node.js / npm / GitHub CLI)
::    2. npm run build:win  â†’  ç”Ÿæˆ setup.exe + portable.exe
::    3. è‡ªåŠ¨åœ¨ GitHub åˆ›å»º Releaseï¼ˆtag = v<version>ï¼‰
::    4. ä¸Šä¼  exe æ–‡ä»¶åˆ° Release
:: ============================================================

setlocal enabledelayedexpansion

cd /d "%~dp0"

echo.
echo  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo  â•‘      roast-me-ai  æ‰“åŒ… + è‡ªåŠ¨å‘å¸ƒ GitHub Release    â•‘
echo  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  è¯»å–ç‰ˆæœ¬å·
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for /f "tokens=2 delims=:, " %%v in ('findstr /i "\"version\"" package.json') do (
    set RAW_VER=%%v
)
set VERSION=%RAW_VER:"=%
set TAG=v%VERSION%
echo  é¡¹ç›®ç‰ˆæœ¬ : %TAG%
echo  GitHub   : https://github.com/suimi8/roast-me-ai
echo.

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  æ£€æŸ¥ Node.js
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
where node >nul 2>&1
if %errorlevel% neq 0 (
    echo  [é”™è¯¯] æœªæ£€æµ‹åˆ° Node.jsï¼Œè¯·å…ˆå®‰è£…: https://nodejs.org/
    pause & exit /b 1
)

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  æ£€æŸ¥ / å®‰è£… GitHub CLI
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
where gh >nul 2>&1
if %errorlevel% neq 0 (
    echo  [æç¤º] æœªæ£€æµ‹åˆ° GitHub CLIï¼Œæ­£åœ¨é€šè¿‡ winget è‡ªåŠ¨å®‰è£…...
    echo.
    winget install --id GitHub.cli -e --silent
    if %errorlevel% neq 0 (
        echo.
        echo  [é”™è¯¯] GitHub CLI å®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å®‰è£…åé‡è¯•ï¼š
        echo         https://cli.github.com/
        pause & exit /b 1
    )
    echo.
    echo  [å®Œæˆ] GitHub CLI å®‰è£…æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°ç¯å¢ƒå˜é‡...
    :: åˆ·æ–° PATH ä½¿ gh ç«‹å³å¯ç”¨
    for /f "skip=2 tokens=3*" %%a in ('reg query HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Environment /v PATH') do set SYS_PATH=%%a %%b
    set PATH=%PATH%;%SYS_PATH%
)

:: å†æ¬¡æ£€æŸ¥ gh æ˜¯å¦å¯ç”¨
where gh >nul 2>&1
if %errorlevel% neq 0 (
    echo.
    echo  [æç¤º] å®‰è£…åéœ€è¦é‡å¯ç»ˆç«¯ä½¿ gh ç”Ÿæ•ˆã€‚
    echo         è¯·å…³é—­æœ¬çª—å£ï¼Œé‡æ–°åŒå‡»è¿è¡Œæ­¤è„šæœ¬ã€‚
    pause & exit /b 1
)

echo  [âœ”] GitHub CLI å·²å°±ç»ª
echo.

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  æ£€æŸ¥ GitHub ç™»å½•çŠ¶æ€
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gh auth status >nul 2>&1
if %errorlevel% neq 0 (
    echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    echo  [è®¤è¯] éœ€è¦ç™»å½• GitHubï¼Œå³å°†æ‰“å¼€æµè§ˆå™¨å®Œæˆæˆæƒ...
    echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    echo.
    gh auth login --web -h github.com
    if %errorlevel% neq 0 (
        echo  [é”™è¯¯] GitHub ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚
        pause & exit /b 1
    )
    echo  [âœ”] GitHub ç™»å½•æˆåŠŸ
    echo.
)

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  æ¸…ç†æ—§äº§ç‰©ï¼ˆå¯é€‰ï¼‰
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set CLEAN_OLD=N
set /p CLEAN_OLD= æ˜¯å¦æ¸…ç† PackageRelease ä¸­çš„æ—§ exe æ–‡ä»¶ï¼Ÿ[y/N]:
echo.
if /i "%CLEAN_OLD%"=="y" (
    if exist "PackageRelease" (
        del /q "PackageRelease\*.exe" 2>nul
        del /q "PackageRelease\*.yml" 2>nul
        del /q "PackageRelease\*.blockmap" 2>nul
        echo  [æ¸…ç†] å®Œæˆã€‚
        echo.
    )
)

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  å®‰è£…ä¾èµ–ï¼ˆå¦‚éœ€ï¼‰
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not exist "node_modules" (
    echo  [æ­¥éª¤ 1/3] å®‰è£… npm ä¾èµ–...
    npm install
    if %errorlevel% neq 0 (
        echo  [é”™è¯¯] npm install å¤±è´¥ã€‚
        pause & exit /b 1
    )
    echo  [âœ”] ä¾èµ–å®‰è£…å®Œæˆã€‚
    echo.
) else (
    echo  [æ­¥éª¤ 1/3] node_modules å·²å­˜åœ¨ï¼Œè·³è¿‡å®‰è£…ã€‚
    echo.
)

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  æ‰“åŒ… Windows
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo  [æ­¥éª¤ 2/3] å¼€å§‹æ‰“åŒ… Windowsï¼ˆNSIS å®‰è£…åŒ… + ä¾¿æºç‰ˆï¼‰...
echo  è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...
echo.

npm run build:win

if %errorlevel% neq 0 (
    echo.
    echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    echo  [å¤±è´¥] æ‰“åŒ…è¿‡ç¨‹å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—ã€‚
    echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    pause & exit /b 1
)

echo.
echo  [âœ”] æ‰“åŒ…å®Œæˆï¼Œæ­£åœ¨æ”¶é›†ç”Ÿæˆæ–‡ä»¶...

:: æ”¶é›† exe æ–‡ä»¶åˆ—è¡¨
set EXE_LIST=
set FOUND=0
for %%f in ("PackageRelease\*.exe") do (
    set EXE_LIST=!EXE_LIST! "%%f"
    echo      âœ”  %%~nxf
    set FOUND=1
)

if "%FOUND%"=="0" (
    echo  [é”™è¯¯] PackageRelease ä¸­æœªæ‰¾åˆ° exe æ–‡ä»¶ï¼Œæ‰“åŒ…å¯èƒ½å¤±è´¥ã€‚
    pause & exit /b 1
)

echo.

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  å‘å¸ƒ GitHub Release
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo  [æ­¥éª¤ 3/3] æ­£åœ¨å‘å¸ƒ GitHub Release %TAG%...
echo.

:: æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
gh release view %TAG% >nul 2>&1
if %errorlevel% equ 0 (
    echo  [æç¤º] Release %TAG% å·²å­˜åœ¨ã€‚
    set OVERWRITE=N
    set /p OVERWRITE= æ˜¯å¦åˆ é™¤æ—§ Release å¹¶é‡æ–°å‘å¸ƒï¼Ÿ[y/N]:
    echo.
    if /i "!OVERWRITE!"=="y" (
        echo  [åˆ é™¤] æ­£åœ¨åˆ é™¤æ—§ Release %TAG%...
        gh release delete %TAG% --yes --cleanup-tag
        echo  [âœ”] æ—§ Release å·²åˆ é™¤ã€‚
        echo.
    ) else (
        echo  [è·³è¿‡] ä¿ç•™å·²æœ‰ Releaseï¼Œä»…ä¸Šä¼ æ–°æ–‡ä»¶...
        goto :upload
    )
)

:: è¾“å…¥ Release è¯´æ˜ï¼ˆå¯é€‰ï¼‰
set RELEASE_NOTES=
set /p RELEASE_NOTES= è¯·è¾“å…¥æœ¬æ¬¡ Release è¯´æ˜ï¼ˆç›´æ¥å›è½¦è·³è¿‡ï¼‰:
echo.

if "%RELEASE_NOTES%"=="" (
    set RELEASE_NOTES=roast-me-ai %TAG% å‘å¸ƒ
)

:: åˆ›å»º Releaseï¼ˆè‰ç¨¿æ¨¡å¼å…ˆåˆ›å»ºï¼Œç„¶åä¸Šä¼ æ–‡ä»¶ï¼‰
echo  æ­£åœ¨åˆ›å»º Release %TAG% ...
gh release create %TAG% ^
    --title "roast-me-ai %TAG%" ^
    --notes "%RELEASE_NOTES%" ^
    --repo suimi8/roast-me-ai

if %errorlevel% neq 0 (
    echo.
    echo  [é”™è¯¯] åˆ›å»º Release å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œ GitHub æƒé™ã€‚
    pause & exit /b 1
)

:upload
:: ä¸Šä¼  exe æ–‡ä»¶
echo.
echo  æ­£åœ¨ä¸Šä¼ å®‰è£…åŒ…æ–‡ä»¶...
gh release upload %TAG% %EXE_LIST% ^
    --repo suimi8/roast-me-ai ^
    --clobber

if %errorlevel% neq 0 (
    echo.
    echo  [é”™è¯¯] æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚
    pause & exit /b 1
)

:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
::  å®Œæˆ
:: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo.
echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo  [æˆåŠŸ] Release å‘å¸ƒå®Œæˆï¼
echo.
echo      ğŸ”— https://github.com/suimi8/roast-me-ai/releases/tag/%TAG%
echo.
echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

set OPEN_PAGE=Y
set /p OPEN_PAGE= æ˜¯å¦åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ Release é¡µé¢ï¼Ÿ[Y/n]:
if /i not "%OPEN_PAGE%"=="n" (
    start "" "https://github.com/suimi8/roast-me-ai/releases/tag/%TAG%"
)

echo.
echo  è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼ŒæŒ‰ä»»æ„é”®é€€å‡º...
pause >nul
exit /b 0
